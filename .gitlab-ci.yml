stages:
  - test
  - release

variables:
  COMPOSER_MEMORY_LIMIT: -1

cache:
  key: notifuse-bundle-vendor
  paths:
    - vendor/

.test_template: &test_template
  image: composer:2
  before_script:
    - composer install --no-interaction --prefer-dist --no-progress
  script:
    - composer validate --strict

unit_tests:
  <<: *test_template
  stage: test
  rules:
    - when: on_success
      exists:
        - composer.json
  artifacts:
    paths:
      - vendor/
    expire_in: 1h

release:
  stage: release
  image: composer:2
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: on_success
    - when: never
  script:
    - chmod +x script/calculate_tag.sh
    - version="$(script/calculate_tag.sh)"
    - tag="v${version}"
    - |
      tag_response=$(curl --silent --show-error --write-out "%{http_code}" --output /tmp/tag_response.txt \
        --request POST "$CI_API_V4_URL/projects/$CI_PROJECT_ID/repository/tags" \
        --header "JOB-TOKEN: $CI_JOB_TOKEN" \
        --form "tag_name=${tag}" \
        --form "ref=${CI_COMMIT_SHA}")
      if [ "$tag_response" = "201" ]; then
        echo "Created Git tag ${tag}"
      elif [ "$tag_response" = "409" ]; then
        echo "Tag ${tag} already exists"
      else
        echo "Failed to create tag ${tag} (HTTP ${tag_response})"
        cat /tmp/tag_response.txt
        exit 1
      fi
    - mkdir -p build
    - composer archive --dir=build --filename="notifuse-symfony-bundle-${version}" --format=zip
    - |
      curl --request POST "$CI_API_V4_URL/projects/$CI_PROJECT_ID/packages/composer" \
        --header "JOB-TOKEN: $CI_JOB_TOKEN" \
        --form "package[name]=notifuse/notifuse-symfony-bundle" \
        --form "package[version]=${version}" \
        --form "package[package_file]=@build/notifuse-symfony-bundle-${version}.zip"
